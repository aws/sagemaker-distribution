#!/bin/bash
set -e

eval "$(micromamba shell hook --shell=bash)"

if [ -n "$SAGEMAKER_RECOVERY_MODE" ]; then
    export HOME=$SAGEMAKER_RECOVERY_MODE_HOME
    # Activate conda environment `sagemaker-recovery-mode`
    micromamba activate sagemaker-recovery-mode
else
    # Activate conda environment 'base'
    micromamba activate base
    # Uninstall SMUS-specific extensions
    micromamba remove -y --no-prune sagemaker-studio-dataengineering-sessions sagemaker-studio-dataengineering-extensions
    # Disable SMUS-specific extensions
    jupyter labextension disable sagemaker-data-explorer:plugin
fi

# Enable S3AG plugin if TIP is enabled
if [ -n "$TRUSTED_IDENTITY_PROPOGATION_ENABLED" ]; then
    export BOTOCORE_EXPERIMENTAL__PLUGINS=S3AccessGrantsPlugin=aws_s3_access_grants_boto3_plugin.s3_access_grants_plugin
    echo BOTOCORE_EXPERIMENTAL__PLUGINS=S3AccessGrantsPlugin=aws_s3_access_grants_boto3_plugin.s3_access_grants_plugin >> ~/.bashrc
fi

# Start Jupyter server in rtc mode for shared spaces
if [ -n "$SAGEMAKER_APP_TYPE_LOWERCASE" ] && [ "$SAGEMAKER_SPACE_TYPE_LOWERCASE" == "shared" ]; then
  jupyter labextension enable @jupyter/collaboration-extension
  # SAGEMAKER_APP_TYPE is set, indicating the server is running within a SageMaker
  # app. Configure the base url to be `/<app-type-in-lower-case>/default`.
  # SAGEMAKER_SPACE_TYPE_LOWERCASE flag is used to determine if the server should start
  # in real-time-collaboration mode for a given space.
  jupyter lab --ip 0.0.0.0 --port 8888 \
    --ServerApp.base_url="/$SAGEMAKER_APP_TYPE_LOWERCASE/default" \
    --ServerApp.token='' \
    --ServerApp.allow_origin='*' \
    --collaborative \
    --ServerApp.identity_provider_class=sagemaker_jupyterlab_extension_common.identity.SagemakerIdentityProvider \
    --YDocExtension.ystore_class=sagemaker_jupyterlab_extension_common.ydoc_override.ydoc.MySQLiteYStore

# Start Jupyter server
elif [ -n "$SAGEMAKER_APP_TYPE_LOWERCASE" ]; then
  # Disable JSD for Private Spaces
  jupyter labextension disable @jupyter-ai-contrib/server-documents
  jupyter server extension disable jupyter_server_documents

  # Re-enable ydoc backend (was disabled by JSD)
  jupyter server extension enable jupyter_server_ydoc

  # Re-enable docprovider (was disabled by JSD in V2)
  jupyter labextension enable @jupyter/docprovider-extension

  # SAGEMAKER_APP_TYPE is set, indicating the server is running within a SageMaker
  # app. Configure the base url to be `/<app-type-in-lower-case>/default`.
  jupyter lab --ip 0.0.0.0 --port 8888 \
    --ServerApp.base_url="/$SAGEMAKER_APP_TYPE_LOWERCASE/default" \
    --ServerApp.token='' \
    --ServerApp.allow_origin='*'
else
  jupyter lab --ip 0.0.0.0 --port 8888 \
    --ServerApp.token='' \
    --ServerApp.allow_origin='*'
fi
